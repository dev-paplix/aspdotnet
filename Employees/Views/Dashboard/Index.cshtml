@model DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class = "container mt-4">
    <div class = "row mb-4">
        <div class = "col-md-12">
            <h2>
                <i class ="bi bi-speedometer2"></i> @ViewData["Title"]
                <small class="text-muted">System Overview</small>
            </h2>
            <p class="text-muted">
                <i class="bi bi-eye-fill"></i> You've viewed this page <strong>@ViewBag.PageViews</strong> time this session. | <i class="bi bi-globe"></i> Total app requested <strong>@ViewBag.TotalRequests</strong> times.
            </p>
            <a asp-action="ResetSession" class="btn btn-sm btn-outline-warning">
                <i class="bi bi-arrow-clockwise"></i> Reset Session
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class = "row g-3 mb-4">
        <div class = "col-md-3">
            <div class = "card text-white bg-primary">
                <div class = "card-body">
                    <div class = "d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class = "card-title">Total Employees</h6>
                            <h3 class = "mb-0">@Model.TotalEmployees</h3>
                        </div>
                        <i class="bi bi-people-fill display-4"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class= "col-md-3">
            <div class = "card text-white bg-success">
                <div class = "card-body">
                    <div class = "d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class = "card-title">Active</h6>
                            <h3 class = "mb-0">@Model.ActiveEmployees</h3>
                        </div>
                        <i class="bi bi-folder-fill display-4"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class= "col-md-3">
            <div class = "card text-white bg-warning">
                <div class = "card-body">
                    <div class = "d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class = "card-title">Inactive</h6>
                            <h3 class = "mb-0">@Model.InactiveEmployees</h3>
                        </div>
                        <i class="bi bi-clock-fill display-4"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class= "col-md-3">
            <div class = "card text-white bg-danger">
                <div class = "card-body">
                    <div class = "d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class = "card-title">Avg Salary</h6>
                            <h3 class = "mb-0">@Model.AverageSalary.ToString("C0")</h3>
                        </div>
                        <i class="bi bi-airplane-engines-fill display-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-3 mb-4">
        <div class = "col-md-6">
            <card title="Employees by Department" header-class="bg-primary text-white">
                <canvas id="departmentChart" height="200"></canvas>
                <div class="mt-3">
                    @foreach (var dept in Model.EmployeesByDepartment.@OrderByDescending(d => d.Value))
                    {
                        <div class="d-flex justify-content-between mb-2">
                            <span><strong>@dept.Key</strong></span>
                            <span class="badge bg-primary">@dept.Value employees</span>
                        </div>
                    }
                </div>
            </card>
        </div>
    

        <!-- Sales Overview -->
        <div class="col-md-6">
            <card title="Salary Overview" header-class="bg-success text-white">
                <dl class="row">
                    <dt class="col-sm-6">Total Salary Expense:</dt>
                    <dd class="col-sm-6">@Model.TotalSalaryExpense.ToString("C0")</dd>

                    <dt class="col-sm-6">Average Salary:</dt>
                    <dd class="col-sm-6">@Model.AverageSalary.ToString("C0")</dd>

                    <dt class="col-sm-6">Monthly Salary:</dt>
                    <dd class="col-sm-6">@((Model.TotalSalaryExpense / 12).ToString("C0"))</dd>
                </dl>
                <button class="btn btn-success w-100" id="loadDeptStats">
                    <i class="bi bi-bar-chart-fill"></i> Load Department Stats (AJAX)
                </button>
            </card>
        </div>
    </div>
    <div class="row g-3">
        <!-- Recent Hires -->
        <div class="col-md-6">
            <card title="Recent Hires" header-class="bg-info text-white">
                <div class="list-group list-group-flush">
                    @foreach (var emp in Model.RecentHires)
                    {
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">@emp.FirstName @emp.LastName</h6>
                                <small>@emp.HireDate.ToString("MMM dd, yyyy")</small>
                            </div>
                            <p class="mb-1">@emp.Position - @emp.Department</p>
                            <small>@emp.Email</small>
                        </div>
                    }
                </div>
            </card>
        </div>
        
        <!-- Highest Paid Employees -->
        <div class="col-md-6">
            <card title="Highest Paid Employees" header-class="bg-warning text-white">
                <div class="list-group list-group-flush">
                    @foreach (var emp in Model.HighestPaidEmployees)
                    {
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">@emp.FirstName @emp.LastName</h6>
                                <strong>@emp.Salary.ToString("C0")</strong>
                            </div>
                            <p class="mb-1">@emp.Position - @emp.Department</p>
                        </div>
                    }
                </div>
            </card>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js"></script>
    <script>
    $(document).ready(function() {
        // Department Chart
        const ctx = document.getElementById('departmentChart');
        const deptData = @Html.Raw(Json.Serialize(Model.EmployeesByDepartment));

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(deptData),
                datasets: [{
                    data: Object.values(deptData),
                    backgroundColor: [
                        '#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });

        // Load Department Stats via AJAX
        $('#loadDeptStats').click(function() {
            const btn = $(this);
            btn.prop('disabled', true).html('<i class="bi bi-arrow-clockwise bi-spin"></i> Loading...');

            $.get('@Url.Action("GetDepartmentStats", "Dashboard")', function(data) {
                $('#deptStatsResult').html(`
                    <div class ="alert alert-success">
                        <h6>All Department Statistics</h6>
                        <p class="mb-0">
                            Count: ${data.count} |
                            Min Salary: ${data.minSalary.toFixed(2)} |
                            Max Salary: ${data.maxSalary.toFixed(2)} |
                            Average Salary: ${data.avgSalary.toFixed(2)}
                        </p>
                    </div>
                    `
                );
                btn.prop('disabled', false).html('<i class="bi bi-bar-chart-fill"></i> Load Department Stats (AJAX)');
            })
        });
    </script>
}